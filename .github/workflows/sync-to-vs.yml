name: Deploy to Web Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v3
      
    - name: üìã List files
      run: |
        echo "üìÅ –§–∞–π–ª—ã –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏:"
        ls -la
        echo ""
        echo "üìÑ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ index.html (–ø–µ—Ä–≤—ã–µ 10 —Å—Ç—Ä–æ–∫):"
        head -10 index.html
        
    - name: üöÄ Deploy to web server
      run: |
        echo "–ù–∞—á–∏–Ω–∞—é –¥–µ–ø–ª–æ–π..."
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ index.html
        if [ ! -f "index.html" ]; then
          echo "‚ùå –û—à–∏–±–∫–∞: index.html –Ω–µ –Ω–∞–π–¥–µ–Ω!"
          exit 1
        fi
        
        # –ö–æ–ø–∏—Ä—É–µ–º –≤ –ø–∞–ø–∫—É –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞
        echo "–ö–æ–ø–∏—Ä—É—é index.html –≤ /var/www/html/"
        sudo cp -v index.html /var/www/html/
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª–æ—Å—å
        if [ -f "/var/www/html/index.html" ]; then
          echo "‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!"
          echo "üìè –†–∞–∑–º–µ—Ä: $(wc -l < index.html) —Å—Ç—Ä–æ–∫"
        else
          echo "‚ùå –û—à–∏–±–∫–∞: —Ñ–∞–π–ª –Ω–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª—Å—è!"
          exit 1
        fi
        
        # –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫—É –≤—Ä–µ–º–µ–Ω–∏
        echo "–í—Ä–µ–º—è –¥–µ–ø–ª–æ—è: $(date)" | sudo tee /var/www/html/deploy_time.txt
        
    - name: üåê Test web server
      run: |
        echo "–ü—Ä–æ–≤–µ—Ä—è—é –≤–µ–±-—Å–µ—Ä–≤–µ—Ä..."
        # –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —Ñ–∞–π–ª –¥–æ—Å—Ç—É–ø–µ–Ω
        if curl -s -I http://localhost | grep -q "200\|301\|302"; then
          echo "‚úÖ –í–µ–±-—Å–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç"
        else
          echo "‚ö†Ô∏è  –ü—Ä–æ–±–ª–µ–º—ã —Å –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–æ–º"
        fi
        
    - name: ‚úÖ Complete
      run: |
        echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
        echo "–°–∞–π—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É —Å–µ—Ä–≤–µ—Ä–∞"
        echo "–§–∞–π–ª: /var/www/html/index.html"
        echo "–í—Ä–µ–º—è: $(date)"
